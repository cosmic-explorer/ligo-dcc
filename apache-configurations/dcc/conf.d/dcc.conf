#
# This is the Apache server configuration file providing SSL support.
# It contains the configuration directives to instruct the server how to
# serve pages over an https connection. For detailing information about these 
# directives see <URL:http://httpd.apache.org/docs/2.2/mod/mod_ssl.html>
# 
# Do NOT simply read the instructions in here without understanding
# what they do.  They're here only as hints or reminders.  If you are unsure
# consult the online docs. You have been warned.  
#

LoadModule ssl_module modules/mod_ssl.so

#
# When we also provide SSL we have to listen to the 
# the HTTPS port in addition.
#
Listen 443

##
##  SSL Global Context
##
##  All SSL configuration in this context applies both to
##  the main server and all SSL-enabled virtual hosts.
##

#
#   Some MIME-types for downloading Certificates and CRLs
#
AddType application/x-x509-ca-cert .crt
AddType application/x-pkcs7-crl    .crl

#   Pass Phrase Dialog:
#   Configure the pass phrase gathering process.
#   The filtering dialog program (`builtin' is a internal
#   terminal dialog) has to provide the pass phrase on stdout.
SSLPassPhraseDialog  builtin

#   Inter-Process Session Cache:
#   Configure the SSL Session Cache: First the mechanism 
#   to use and second the expiring timeout (in seconds).
#SSLSessionCache        dc:UNIX:/var/cache/mod_ssl/distcache
SSLSessionCache         shmcb:/var/cache/mod_ssl/scache(512000)
SSLSessionCacheTimeout  300

#   Semaphore:
#   Configure the path to the mutual exclusion semaphore the
#   SSL engine uses internally for inter-process synchronization. 
SSLMutex default

#   Pseudo Random Number Generator (PRNG):
#   Configure one or more sources to seed the PRNG of the 
#   SSL library. The seed data should be of good random quality.
#   WARNING! On some platforms /dev/random blocks if not enough entropy
#   is available. This means you then cannot use the /dev/random device
#   because it would lead to very long connection times (as long as
#   it requires to make more entropy available). But usually those
#   platforms additionally provide a /dev/urandom device which doesn't
#   block. So, if available, use this one instead. Read the mod_ssl User
#   Manual for more details.
SSLRandomSeed startup file:/dev/urandom  256
SSLRandomSeed connect builtin
#SSLRandomSeed startup file:/dev/random  512
#SSLRandomSeed connect file:/dev/random  512
#SSLRandomSeed connect file:/dev/urandom 512

#
# Use "SSLCryptoDevice" to enable any supported hardware
# accelerators. Use "openssl engine -v" to list supported
# engine names.  NOTE: If you enable an accelerator and the
# server does not start, consult the error logs and ensure
# your accelerator is functioning properly. 
#
SSLCryptoDevice builtin
#SSLCryptoDevice ubsec

##
## SSL Virtual Host Context
##

#
#  VirtualHost configuration for dcc.ligo.org
#

<VirtualHost *:443>
    DocumentRoot "/usr1/www/html"
    ServerName dcc.ligo.org

    RewriteEngine On
    #RewriteCond   %{HTTP_HOST}   ^dcc-backup\.ligo\.org$
    #RewriteRule   ^(.*) /dcc-backup-is-gone.html

    # Use separate log files for the SSL virtual host; note that LogLevel
    # is not inherited from httpd.conf.
    ErrorLog logs/dcc_ssl_error_log
    TransferLog logs/dcc_ssl_access_log
    LogLevel warn

    #   SSL Engine Switch:
    #   Enable/Disable SSL for this virtual host.
    SSLEngine on
    
    #   SSL Protocol support:
    # List the enable protocol levels with which clients will be able to
    # connect.  Disable SSLv2 access by default:
    SSLProtocol all -SSLv2
        
    # Due to the exploit path known as B.E.A.S.T., the cipher suite
    # needs to be carefully constructed. The follwoing was proposed
    # by an Apache developer.
    SSLHonorCipherOrder on
    SSLCipherSuite RC4-SHA:AES128-SHA:HIGH:MEDIUM:!aNULL:!MD5 

    # Comodo/InCommon Commercial 3-Year Cert
    SSLCertificateFile /etc/httpd/certs/localhost.crt
    SSLCertificateKeyFile /etc/httpd/certs/localhost.key
    SSLCACertificateFile /etc/httpd/certs/ca-bundle.crt

    SSLVerifyClient none
    <Files ~ "\.(cgi|shtml|phtml|php3?)$">
        SSLOptions +StdEnvVars
    </Files>

    Timeout 1000

     <Directory />
        ErrorDocument 404 https://dcc.ligo.org
        ErrorDocument 403 https://dcc.ligo.org/403.html
        AllowOverride All
        #AuthDBMGroupFile /etc/httpd/conf/htdbtest
        #Require isMemberOf ~ .+DCCTesters.*
     </Directory> 
     
     <Directory /usr1/www/html>
        Options +FollowSymLinks +Includes
        AllowOverride All
        XBitHack on
     </Directory>
    
    DefineExternalGroup dccauth environment /usr1/www/cgi-bin/private/DocDB/RemoteUserHasAccess
     <Directory "/usr1/www/html/DocDB">
        AuthType shibboleth
        AuthName "This content is viewable by only LIGO/Virgo personnel. Please enter your LIGO Directory name, e.g. albert.einstein, and password to continue."
        ShibRequireAll On
        AuthzShibAuthoritative Off
        ShibRequestSetting requireSession 1
        GroupExternal dccauth
        Require group foobar
     </Directory>

     ScriptAlias /dcc  /usr1/www/cgi-bin/private/DocDB/DocumentDatabase 
     ScriptAlias /pub  /usr1/www/cgi-bin/DocDB/DocumentDatabase 
     Alias /wiki /usr1/www/html/mediawiki-1.20.2

    <Location /wiki>
        AuthType Shibboleth
        AuthName "This content is viewable by only LIGO/Virgo personnel. Please enter your LIGO Directory name, e.g. albert.einstein, and password to continue."
        ShibRequireAll On
        AuthzShibAuthoritative On
        ShibRequestSetting requireSession 1
        Require valid-user
    </Location>

#     AddExternalAuth barfoo /usr1/www/cgi-bin/phil/auth.sh
#     SetExternalAuthMethod barfoo environment
#     <Directory "/usr1/www/html/wiki">
#        AuthType Basic
#        AuthName Phil
#        AuthBasicProvider external
#        AuthExternal barfoo
#        Require valid-user
#     </Directory>

    # This one for shib
    #DefineExternalGroup barfoo environment /usr1/www/cgi-bin/phil/auth.sh
    # These two for basic auth
    #AddExternalAuth barfoo /usr1/www/cgi-bin/phil/auth.sh
    #SetExternalAuthMethod barfoo environment
    #
    <Directory "/usr1/www/cgi-bin/private/DocDB">
        AuthType shibboleth
        AuthName "This content is viewable by only LIGO/Virgo personnel. Please enter your LIGO Directory name, e.g. albert.einstein, and password to continue."
        ShibRequireAll On
        AuthzShibAuthoritative On
        ShibRequestSetting requireSession 1
        require valid-user
    </Directory>

    # It's always amazed me that you could get above DocumentRoot
    # like this. - Phil
    Alias /e-traveler /usr1/www/E-Traveler/html
    ScriptAlias /et-cgi /usr1/www/E-Traveler/cgi-bin

    <Directory "/usr1/www/E-Traveler">
      ErrorDocument 403 default
      ErrorDocument 404 default
      AuthType shibboleth
      AuthName "This content is viewable by only LIGO/Virgo personnel. Please enter your LIGO Directory name, e.g. albert.einstein, and password to continue."
      ShibRequireAll On
      AuthzShibAuthoritative On
      ShibRequestSetting requireSession 1
      require valid-user
      XBitHack on
      Options +IncludesNoExec FollowSymLinks
    </Directory>

    # So folks can cruise the created docs via index
    <Directory "/usr1/www/E-Traveler/html/data">
       Options Indexes FollowSymLinks +IncludesNoExec
    </Directory>

    <Directory "/usr1/www/html/public">
        Options Indexes FollowSymLinks +IncludesNoExec
    </Directory>

    SetEnvIf User-Agent ".*MSIE.*" \
             nokeepalive ssl-unclean-shutdown \
             downgrade-1.0 force-response-1.0
    CustomLog logs/dcc_ssl_request_log \
             "%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x \"%r\" %b"
</VirtualHost>                                  

RewriteEngine On
RewriteCond %{HTTPS} !on
RewriteRule ^/(.*) https://%{SERVER_NAME}%{REQUEST_URI} [R]
